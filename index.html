<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Baixas de Consumo</title>

    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

</head>
<body class="bg-gray-100 font-sans">

    <div id="loginContainer" class="auth-container" style="background: var(--darker); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; position: relative;">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 180, 216, 0.1); backdrop-filter: blur(5px);"></div>
        <div class="main-login-grid" style="display: grid; grid-template-columns: 1fr 2fr; gap: 40px; max-width: 1400px; width: 90vw; z-index: 10;">
            <div class="auth-card" style="grid-column: span 1; background: white; padding: 50px 40px; border-radius: 16px; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);">
                <div class="auth-header" style="text-align: center;">
                    <img src="teste.png" class="w-40 h-auto mb-6 mx-auto object-contain" alt="Logo JP Tech">
                    <h2 style="color: var(--dark); font-size: 1.8rem; font-weight: 700;">Acesso ao Sistema</h2>
                    <p style="color: var(--secondary); font-size: 1rem; margin-bottom: 30px;">Controle de Baixas de Consumo</p>
                </div>
                <form id="loginForm" class="auth-form">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="username" style="display: none;">Usuário:</label>
                        <input type="text" id="username" placeholder="Usuário" required style="width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 8px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="password" style="display: none;">Senha:</label>
                        <input type="password" id="password" placeholder="Senha" required style="width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 8px;">
                    </div>
                    <div class="form-group" id="filialSelectGroup" style="display: none; margin-bottom: 30px;">
                        <label for="filialSelect" class="block mb-1 font-semibold text-sm text-gray-700">Selecione a Filial:</label>
                        <select id="filialSelect" style="width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 8px;"></select>
                    </div>
                    <button type="submit" class="btn btn-primary w-full" style="background: var(--primary-gradient); color: white; padding: 14px; border-radius: 8px; font-weight: 700; font-size: 1rem;">ENTRAR</button>
                </form>
                <div id="loginAlert" class="mt-4" style="text-align: center;"></div>
                </div>

            <div style="grid-column: span 1; display: grid; grid-template-rows: 1fr 1fr; gap: 40px;">
                 <div style="background: var(--secondary-gradient); color: white; padding: 40px; border-radius: 16px; box-shadow: 0 15px 50px rgba(0, 119, 182, 0.3); display: flex; flex-direction: column; justify-content: center;">
                    <div style="font-size: 2.5rem; font-weight: 800; line-height: 1.2;">CONTROLE EFICIENTE, REDUÇÃO DE CUSTOS.</div>
                    <div style="font-size: 1.1rem; margin-top: 15px; font-weight: 400; opacity: 0.9;">Gerencie as baixas de consumo com precisão, agilidade e total rastreabilidade.</div>
                </div>
                 <div style="background: white; padding: 40px; border-radius: 16px; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15); border-left: 5px solid var(--primary); display: flex; flex-direction: column; justify-content: center;">
                    <div style="color: var(--accent); font-weight: 700; margin-bottom: 10px;">FLUXO SIMPLIFICADO</div>
                    <h3 style="font-size: 1.2rem; font-weight: 700; color: var(--dark); margin-bottom: 15px;">GESTÃO DE BAIXAS EM ETAPAS</h3>
                    <ul style="list-style-type: none; margin: 0; padding: 0; font-size: 0.95rem; color: #555;">
                        <li style="margin-bottom: 5px;"><span style="color: var(--primary); font-weight: 600;">1. Solicitação:</span> Operação registra a necessidade.</li>
                        <li style="margin-bottom: 5px;"><span style="color: var(--primary); font-weight: 600;">2. Aprovação:</span> Gestor autoriza ou nega.</li>
                        <li style="margin-bottom: 5px;"><span style="color: var(--primary); font-weight: 600;">3. Execução:</span> Prevenção realiza a baixa e anexa comprovantes.</li>
                        <li><span style="color: var(--primary); font-weight: 600;">4. Retirada:</span> Operação confirma o recebimento e anexa foto.</li>
                    </ul>
                </div>
            </div>
        </div>
        <div style="position: absolute; bottom: 20px; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; text-align: center; width: 100%; z-index: 10;">
            © 2025 - Controle de Baixas | Desenvolvido por <span style="font-weight: 700;">@ JP Tech Solutions</span>
        </div>
    </div>

    <div id="mainSystem" class="flex h-screen" style="display: none;">
        <aside class="sidebar">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center">
                    <i data-feather="clipboard" class="h-8 w-8 text-blue-400 mr-3"></i>
                    <h1 class="text-xl font-bold text-white">Controle de Baixas</h1>
                </div>
                <p class="text-sm text-gray-300 mt-2">Usuário: <span class="font-medium" id="sidebarUser">N/A</span></p>
                <p class="text-sm text-gray-300 mt-1">Filial: <span class="font-medium" id="sidebarFilial">N/A</span></p>
            </div>
            <nav class="p-4">
                <a href="#novaSolicitacao" class="nav-item p-3 rounded-lg mb-2 flex items-center cursor-pointer" onclick="showView('novaSolicitacaoView', this)" data-role="operacao">
                    <i data-feather="plus-circle" class="h-5 w-5 mr-3"></i>
                    <span>Nova Solicitação</span>
                </a>
                 <a href="#minhasSolicitacoes" class="nav-item p-3 rounded-lg mb-2 flex items-center cursor-pointer" onclick="showView('minhasSolicitacoesView', this)" data-role="operacao">
                    <i data-feather="list" class="h-5 w-5 mr-3"></i>
                    <span>Minhas Solicitações</span>
                </a>
                 <a href="#aprovarSolicitacoes" class="nav-item p-3 rounded-lg mb-2 flex items-center cursor-pointer" onclick="showView('aprovarSolicitacoesView', this)" data-role="gestor">
                    <i data-feather="check-square" class="h-5 w-5 mr-3"></i>
                    <span>Aprovar Baixas</span>
                </a>
                 <a href="#executarSolicitacoes" class="nav-item p-3 rounded-lg mb-2 flex items-center cursor-pointer" onclick="showView('executarSolicitacoesView', this)" data-role="prevencao">
                    <i data-feather="tool" class="h-5 w-5 mr-3"></i>
                    <span>Executar Baixas</span>
                </a>
                 <a href="#historicoBaixas" class="nav-item p-3 rounded-lg mb-2 flex items-center cursor-pointer" onclick="showView('historicoBaixasView', this)" data-role="gestor,prevencao,admin"> <i data-feather="archive" class="h-5 w-5 mr-3"></i>
                    <span>Histórico Geral</span>
                </a>
                
                <a href="#gerenciarUsuarios" class="nav-item p-3 rounded-lg mb-2 flex items-center cursor-pointer" onclick="showView('gerenciarUsuariosView', this)" data-role="admin">
                    <i data-feather="users" class="h-5 w-5 mr-3"></i>
                    <span>Gerenciar Usuários</span>
                </a>
                <a href="#gerenciarFiliais" class="nav-item p-3 rounded-lg mb-2 flex items-center cursor-pointer" onclick="showView('gerenciarFiliaisView', this)" data-role="admin">
                    <i data-feather="briefcase" class="h-5 w-5 mr-3"></i>
                    <span>Gerenciar Filiais</span>
                </a>
                <div id="logoutLink" class="p-3 rounded-lg mt-auto flex items-center text-red-400 cursor-pointer hover:bg-gray-700" onclick="logout()">
                    <i data-feather="log-out" class="h-5 w-5 mr-3"></i>
                    <span>Sair</span>
                </div>
            </nav>
        </aside>

        <main class="flex-1 overflow-auto bg-gray-100 main-content">
            <div class="container mx-auto px-6 py-8">

                <div id="homeView" class="view-content active">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Bem-vindo(a)!</h1>
                    <p class="text-gray-600">Selecione uma opção no menu lateral para começar.</p>
                    </div>

                <div id="novaSolicitacaoView" class="view-content">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Nova Solicitação de Baixa</h1>
                    <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
                        <form id="novaSolicitacaoForm">
                            <div class="form-group mb-4">
                                <label for="produtoCodigo">Código do Produto:</label>
                                <input type="text" id="produtoCodigo" required class="w-full">
                            </div>
                            <div class="form-group mb-4">
                                <label>Descrição:</label>
                                <input type="text" id="produtoDescricao" readonly disabled class="w-full bg-gray-200">
                                <input type="hidden" id="produtoId">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="form-group">
                                    <label for="quantidadeSolicitada">Quantidade:</label>
                                    <input type="number" id="quantidadeSolicitada" min="1" required class="w-full">
                                </div>
                                <div class="form-group">
                                    <label for="valorUnitarioSolicitado">Valor Unitário (R$):</label>
                                    <input type="number" id="valorUnitarioSolicitado" step="0.01" min="0" required class="w-full">
                                </div>
                                <div class="form-group">
                                    <label>Valor Total (R$):</label>
                                    <input type="text" id="valorTotalSolicitado" readonly disabled class="w-full bg-gray-200">
                                </div>
                            </div>
                            <div class="mt-6 text-center">
                                <button type="submit" class="btn btn-success w-full md:w-auto">Enviar Solicitação</button>
                            </div>
                        </form>
                        <div id="novaSolicitacaoAlert" class="mt-4"></div>
                    </div>
                </div>

                <div id="minhasSolicitacoesView" class="view-content">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Minhas Solicitações</h1>
                    <div class="table-container bg-white rounded-lg shadow-md">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data</th>
                                    <th>Produto</th>
                                    <th>Qtd. Sol.</th>
                                    <th>Valor Sol. (R$)</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="minhasSolicitacoesBody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="aprovarSolicitacoesView" class="view-content">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Aprovar Solicitações Pendentes</h1>
                    <div class="table-container bg-white rounded-lg shadow-md">
                         <table class="w-full">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data</th>
                                    <th>Solicitante</th>
                                    <th>Produto</th>
                                    <th>Qtd.</th>
                                    <th>Valor (R$)</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="aprovarSolicitacoesBody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="executarSolicitacoesView" class="view-content">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Executar Baixas Aprovadas</h1>
                    <div class="table-container bg-white rounded-lg shadow-md">
                         <table class="w-full">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data Sol.</th>
                                    <th>Solicitante</th>
                                    <th>Produto</th>
                                    <th>Qtd. Sol.</th>
                                    <th>Valor Sol. (R$)</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="executarSolicitacoesBody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="historicoBaixasView" class="view-content">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Histórico Geral de Baixas</h1>
                    <div class="table-container bg-white rounded-lg shadow-md">
                        <table class="w-full">
                             <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data</th>
                                    <th>Filial</th>
                                    <th>Solicitante</th>
                                    <th>Produto</th>
                                    <th>Qtd. Exec.</th>
                                    <th>Valor Exec. (R$)</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="historicoBaixasBody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="gerenciarUsuariosView" class="view-content">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Gerenciar Usuários</h1>
                        <button class="btn btn-success" onclick="abrirUsuarioModal(null)">
                            <i data-feather="plus" class="h-4 w-4 inline-block -mt-1 mr-1"></i>
                            Novo Usuário
                        </button>
                    </div>
                    <div class="table-container bg-white rounded-lg shadow-md">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Usuário (login)</th>
                                    <th>Grupo (Role)</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="usuariosTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="gerenciarFiliaisView" class="view-content">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Gerenciar Filiais</h1>
                        <button class="btn btn-success" onclick="abrirFilialModal(null)">
                            <i data-feather="plus" class="h-4 w-4 inline-block -mt-1 mr-1"></i>
                            Nova Filial
                        </button>
                    </div>
                    <div class="table-container bg-white rounded-lg shadow-md">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome (Ex: 464)</th>
                                    <th>Descrição (Ex: MT - Cuiabá)</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="filiaisTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>


            </div>
        </main>
    </div>

    <div id="detalhesModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xl font-semibold">Detalhes da Solicitação #<span id="detalhesId"></span></h3>
                 <button class="btn btn-danger btn-small" onclick="closeModal('detalhesModal')">Fechar</button>
            </div>
            <div id="detalhesContent" class="space-y-3 text-sm">
                </div>
        </div>
    </div>

    <div id="executarModal" class="modal-overlay">
        <div class="modal-content">
             <h3 class="text-xl font-semibold mb-4">Executar Baixa - Solicitação #<span id="executarId"></span></h3>
             <form id="executarForm">
                 <input type="hidden" id="executarSolicitacaoId">
                 <div class="mb-4 p-3 bg-gray-100 rounded border border-gray-200">
                     <p><strong>Produto:</strong> <span id="executarProduto"></span></p>
                     <p><strong>Qtd. Solicitada:</strong> <span id="executarQtdSolicitada"></span></p>
                     <p><strong>Valor Solicitado:</strong> R$ <span id="executarValorSolicitado"></span></p>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                     <div class="form-group">
                         <label for="quantidadeExecutada">Qtd. Real Baixada:</label>
                         <input type="number" id="quantidadeExecutada" min="0" required class="w-full">
                     </div>
                     <div class="form-group">
                         <label for="valorUnitarioExecutado">Valor Unit. Real (R$):</label>
                         <input type="number" id="valorUnitarioExecutado" step="0.01" min="0" required class="w-full">
                     </div>
                     <div class="form-group">
                         <label>Valor Total Real (R$):</label>
                         <input type="text" id="valorTotalExecutado" readonly disabled class="w-full bg-gray-200">
                     </div>
                 </div>
                 <div class="form-group mb-4">
                     <label for="justificativaExecucao">Justificativa:</label>
                     <textarea id="justificativaExecucao" rows="3" required class="w-full"></textarea>
                 </div>
                 <div class="form-group mb-4">
                     <label for="codigoMovimentacao">Código Movimentação:</label>
                     <input type="text" id="codigoMovimentacao" required class="w-full">
                 </div>
                 <div class="form-group mb-4">
                     <label for="anexosExecucao">Anexos (Opcional):</label>
                     <input type="file" id="anexosExecucao" multiple class="w-full text-sm">
                     <small class="text-gray-500">Selecione um ou mais arquivos (PDF, Imagem).</small>
                 </div>
                 <div id="executarAlert" class="mt-4"></div>
                 <div class="flex gap-4 mt-6">
                     <button type="submit" class="btn btn-success flex-1">Confirmar Execução</button>
                     <button type="button" class="btn btn-danger flex-1" onclick="closeModal('executarModal')">Cancelar</button>
                 </div>
             </form>
        </div>
    </div>

     <div id="retiradaModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
             <h3 class="text-xl font-semibold mb-4">Confirmar Retirada - Solicitação #<span id="retiradaId"></span></h3>
             <form id="retiradaForm">
                 <input type="hidden" id="retiradaSolicitacaoId">
                 <div class="mb-4 p-3 bg-gray-100 rounded border border-gray-200">
                     <p><strong>Produto:</strong> <span id="retiradaProduto"></span></p>
                     <p><strong>Qtd. Executada:</strong> <span id="retiradaQtdExecutada"></span></p>
                     <p><strong>Valor Executado:</strong> R$ <span id="retiradaValorExecutado"></span></p>
                 </div>
                 <div class="form-group mb-4">
                     <label for="fotoRetirada">Foto da Retirada:</label>
                     <input type="file" id="fotoRetirada" accept="image/*" required class="w-full text-sm">
                     <small class="text-gray-500">Anexe a foto do material sendo retirado.</small>
                 </div>
                 <div id="retiradaAlert" class="mt-4"></div>
                 <div class="flex gap-4 mt-6">
                     <button type="submit" class="btn btn-success flex-1">Confirmar Retirada</button>
                     <button type="button" class="btn btn-danger flex-1" onclick="closeModal('retiradaModal')">Cancelar</button>
                 </div>
             </form>
        </div>
    </div>

    <div id="usuarioModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="text-xl font-semibold mb-4" id="usuarioModalTitle">Novo Usuário</h3>
            <form id="usuarioForm">
                <input type="hidden" id="usuarioId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="usuarioNome">Nome Completo:</label>
                        <input type="text" id="usuarioNome" required class="w-full">
                    </div>
                    <div class="form-group">
                        <label for="usuarioUsername">Usuário (login):</label>
                        <input type="text" id="usuarioUsername" required class="w-full">
                    </div>
                </div>
                <div class="form-group mb-4">
                    <label for="usuarioSenha">Senha:</label>
                    <input type="password" id="usuarioSenha" class="w-full">
                    <small class="text-gray-500" id="usuarioSenhaHelp">Deixe em branco para não alterar a senha (ao editar).</small>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label for="usuarioRole">Grupo (Role):</label>
                        <select id="usuarioRole" required class="w-full">
                            <option value="" disabled>Selecione...</option>
                            <option value="admin">Admin</option>
                            <option value="gestor">Gestor</option>
                            <option value="prevencao">Prevenção</option>
                            <option value="operacao">Operação</option>
                        </select>
                    </div>
                    <div class="form-group flex items-center pt-6">
                        <input type="checkbox" id="usuarioAtivo" class="h-5 w-5" checked>
                        <label for="usuarioAtivo" class="ml-2 font-normal">Usuário Ativo</label>
                    </div>
                </div>
                <div class="form-group mb-4">
                    <label class="block mb-1">Filiais Associadas:</label>
                    <div id="usuarioFiliaisCheckboxes" class="max-h-32 overflow-y-auto bg-gray-50 p-3 border rounded-md grid grid-cols-2 gap-2">
                        <div class="loading text-sm">Carregando filiais...</div>
                    </div>
                </div>

                <div id="usuarioAlert" class="mt-4"></div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="btn btn-success flex-1">Salvar Usuário</button>
                    <button type="button" class="btn btn-danger flex-1" onclick="closeModal('usuarioModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="filialModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-xl font-semibold mb-4" id="filialModalTitle">Nova Filial</h3>
            <form id="filialForm">
                <input type="hidden" id="filialId">
                <div class="form-group mb-4">
                    <label for="filialNome">Nome (Ex: 464):</label>
                    <input type="text" id="filialNome" required class="w-full">
                </div>
                <div class="form-group mb-4">
                    <label for="filialDescricao">Descrição (Ex: MT - Cuiabá):</label>
                    <input type="text" id="filialDescricao" required class="w-full">
                </div>
                
                <div id="filialAlert" class="mt-4"></div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="btn btn-success flex-1">Salvar Filial</button>
                    <button type="button" class="btn btn-danger flex-1" onclick="closeModal('filialModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>


    <div id="notificationContainer"></div>

    <script>
        // Configuração Inicial - Use o Proxy
        const SUPABASE_PROXY_URL = '/api/proxy'; // Aponta para a sua serverless function
        // Credenciais removidas daqui e movidas para o Vercel
    </script>
    <script src="script.js"></script>
    <script>
        // Inicializar ícones e animações
        feather.replace();
        if (typeof AOS !== 'undefined') {
            AOS.init({ duration: 600, once: true });
        }
    </script>

</body>
</html>
